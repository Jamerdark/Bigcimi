name: ğŸš€ Build MinUI with Patch File

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target device'
        required: true
        default: 'rg35xx'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: Checkout our repo (to get patches)
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4
      
    # Step 2: Verify patch files exist
    - name: ğŸ” Check patch files
      run: |
        echo "Current directory: $(pwd)"
        echo "Checking for patch files..."
        
        if [ -f "patches/minui-ci.patch" ]; then
          echo "âœ… Found patch file: patches/minui-ci.patch"
          echo "Patch content preview:"
          head -20 patches/minui-ci.patch
        else
          echo "âŒ ERROR: patches/minui-ci.patch not found!"
          echo "Listing directory:"
          ls -la
          exit 1
        fi
        
        if [ -f "patches/apply-patch.sh" ]; then
          echo "âœ… Found patch script: patches/apply-patch.sh"
          chmod +x patches/apply-patch.sh
        else
          echo "âš ï¸ Warning: patches/apply-patch.sh not found"
        fi
        
    # Step 3: Clone MinUI
    - name: ğŸ”„ Clone MinUI
      run: |
        git clone --depth 1 https://github.com/shauninman/MinUI.git minui-build
        
    # Step 4: Apply patches
    - name: ğŸ”§ Apply patches
      run: |
        cd minui-build
        
        echo "Applying patch file..."
        
        # Make sure patch command is available
        sudo apt-get update
        sudo apt-get install -y patch
        
        # Apply the patch
        if patch -p1 -i ../patches/minui-ci.patch; then
          echo "âœ… Patch applied successfully"
        else
          echo "âš ï¸ Patch may have already been applied or failed"
          # Try to apply manually
          echo "Trying manual patches..."
          sed -i 's/tty -s/# tty -s  # Disabled for CI/' makefile
          sed -i 's/find -E /find /g' makefile
        fi
        
        # Run patch script if exists
        if [ -f "../patches/apply-patch.sh" ]; then
          echo "Running patch script..."
          ../patches/apply-patch.sh || echo "Patch script completed"
        fi
        
    # Step 5: Install dependencies
    - name: ğŸ“¥ Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libsdl2-mixer-dev
        
    # Step 6: Build
    - name: ğŸ”¨ Build MinUI
      run: |
        cd minui-build
        
        echo "Building for: ${{ github.event.inputs.target }}"
        
        # Clean first
        make clean 2>/dev/null || true
        
        # Build
        if [ "${{ github.event.inputs.target }}" = "default" ]; then
          make
        else
          make TARGET=${{ github.event.inputs.target }}
        fi
        
        # List results
        echo "Build results:"
        ls -la *.zip *.elf *.img *.bin 2>/dev/null || echo "No output files"
        
    # Step 7: Upload
    - name: ğŸ“¤ Upload results
      uses: actions/upload-artifact@v4
      with:
        name: minui-build
        path: minui-build/*.zip
