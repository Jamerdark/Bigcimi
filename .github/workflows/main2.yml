---
name: Clone and Build NextUI

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "URL repository NextUI yang akan di-clone"
        default: "https://github.com/LoveRetro/NextUI.git"
        required: true
      source_branch:
        description: "Branch yang akan di-clone"
        default: "main"
        required: false
      release_type:
        description: "Release type untuk tag"
        default: "patch"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        # Default saja, tidak wajib jika hanya build tanpa release

permissions:
  attestations: write
  contents: write
  id-token: write

jobs:
  clone-and-prepare:
    runs-on: ubuntu-24.04
    outputs:
      next-tag: ${{ steps.next-tag.outputs.version }}
      release-name: ${{ steps.release-name.outputs.RELEASE_NAME }}
      commit-hash: ${{ steps.get-commit.outputs.commit-hash }}
    steps:
      - name: Checkout repository tujuan (untuk menyimpan hasil)
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Clone repository NextUI
        id: clone-repo
        run: |
          echo "ðŸ” Cloning repository: ${{ github.event.inputs.source_repo }}"
          echo "ðŸŒ¿ Branch: ${{ github.event.inputs.source_branch || 'main' }}"
          
          # Clone repository NextUI
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" nextui-source
          
          echo "âœ… Repository berhasil di-clone"
          cd nextui-source
          
          # Simpan informasi commit
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_OUTPUT
          
          # Generate release name
          if [ -f "Makefile" ] && make -n name 2>/dev/null; then
            RELEASE_NAME=$(make name)
          else
            RELEASE_NAME="NextUI-build-$(date +%Y%m%d-%H%M%S)-$COMMIT_HASH"
          fi
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          # Get latest tag dari repo sumber
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          echo "ðŸ”– Latest Tag: $LATEST_TAG"
          echo "ðŸ·ï¸ Release Name: $RELEASE_NAME"
          echo "ðŸ”— Commit: $COMMIT_HASH"

      - name: Generate Release Name
        id: release-name
        run: |
          echo "RELEASE_NAME=${{ steps.clone-repo.outputs.RELEASE_NAME }}" >> "$GITHUB_OUTPUT"

      - name: Get Commit Hash
        id: get-commit
        run: |
          echo "commit-hash=${{ steps.clone-repo.outputs.COMMIT_HASH }}" >> "$GITHUB_OUTPUT"

      - name: Compute Next Tag
        id: next-tag
        if: github.event.inputs.release_type != 'none'
        uses: docker://ghcr.io/dokku/semver-generator:latest
        with:
          bump: ${{ github.event.inputs.release_type }}
          input: ${{ steps.clone-repo.outputs.LATEST_TAG }}

  core-matrix:
    needs: clone-and-prepare
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    outputs:
      cores: ${{ steps.cores.outputs.cores }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040
          - tg5050

    steps:
      - name: Clone repository NextUI (untuk build)
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" nextui-source
          cd nextui-source

      - name: Generate cores matrix
        id: cores
        run: |
          cd nextui-source
          CORES="$(make cores-json)"
          echo "cores=$CORES" >> $GITHUB_OUTPUT

  build-core:
    needs: core-matrix
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040
          - tg5050
        core: ${{ fromJson(needs.core-matrix.outputs.cores) }}
    steps:
      - name: Clone repository NextUI
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" nextui-source
          cd nextui-source

      - name: Setup
        run: |
          cd nextui-source
          make setup

      - name: Build ${{ matrix.core }} core
        run: |
          cd nextui-source
          make build-core CORE=${{ matrix.core }}

      - name: Upload core artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: core-${{ matrix.toolchain }}-${{ matrix.core }}.zip
          path: nextui-source/workspace/${{ env.PLATFORM }}/cores/output/

  build:
    needs:
      - clone-and-prepare
      - build-core
    runs-on: ubuntu-24.04-arm
    env:
      RELEASE_NAME: ${{ needs.clone-and-prepare.outputs.release-name }}
    steps:
      - name: Clone repository NextUI untuk final build
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" nextui-source
          cd nextui-source

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipmerge

      - name: Setup build environment
        run: |
          cd nextui-source
          make setup

      - name: Download Cores (tg5040)
        uses: actions/download-artifact@v4.3.0
        with:
          path: nextui-source/workspace/tg5040/cores/output/
          pattern: core-tg5040-*
          merge-multiple: true

      - name: Build untuk tg5040 platform
        run: |
          cd nextui-source
          make tg5040
        env:
          PLATFORM: tg5040

      - name: Download Cores (tg5050)
        uses: actions/download-artifact@v4.3.0
        with:
          path: nextui-source/workspace/tg5050/cores/output/
          pattern: core-tg5050-*
          merge-multiple: true

      - name: Build untuk tg5050 platform
        run: |
          cd nextui-source
          make tg5050
        env:
          PLATFORM: tg5050

      - name: Build komponen special
        run: |
          cd nextui-source
          make special

      - name: Package semua build
        run: |
          cd nextui-source
          make package

      - name: Upload hasil build ke artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ env.RELEASE_NAME }}-build-output
          path: |
            nextui-source/releases/${{ env.RELEASE_NAME }}-all.zip
            nextui-source/releases/${{ env.RELEASE_NAME }}-base.zip
            nextui-source/releases/${{ env.RELEASE_NAME }}-extras.zip
          retention-days: 30

      - name: Copy hasil build ke repository ini
        run: |
          # Buat folder untuk menyimpan build di repo ini
          mkdir -p builds/${{ env.RELEASE_NAME }}
          
          # Copy file hasil build
          if [ -f "nextui-source/releases/${{ env.RELEASE_NAME }}-all.zip" ]; then
            cp nextui-source/releases/${{ env.RELEASE_NAME }}-all.zip builds/${{ env.RELEASE_NAME }}/
          fi
          if [ -f "nextui-source/releases/${{ env.RELEASE_NAME }}-base.zip" ]; then
            cp nextui-source/releases/${{ env.RELEASE_NAME }}-base.zip builds/${{ env.RELEASE_NAME }}/
          fi
          if [ -f "nextui-source/releases/${{ env.RELEASE_NAME }}-extras.zip" ]; then
            cp nextui-source/releases/${{ env.RELEASE_NAME }}-extras.zip builds/${{ env.RELEASE_NAME }}/
          fi
          
          # Buat file info build
          cat > builds/${{ env.RELEASE_NAME }}/build-info.txt << EOF
          Build Information
          =================
          Build Name: ${{ env.RELEASE_NAME }}
          Source Repo: ${{ github.event.inputs.source_repo }}
          Source Branch: ${{ github.event.inputs.source_branch || 'main' }}
          Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}
          Build Date: $(date)
          Release Type: ${{ github.event.inputs.release_type }}
          =================
          EOF
          
          # Tampilkan struktur file
          echo "ðŸ“ Build files saved to builds/${{ env.RELEASE_NAME }}/:"
          ls -la builds/${{ env.RELEASE_NAME }}/

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2.3.0
        with:
          subject-path: |
            nextui-source/releases/${{ env.RELEASE_NAME }}-all.zip
            nextui-source/releases/${{ env.RELEASE_NAME }}-base.zip
            nextui-source/releases/${{ env.RELEASE_NAME }}-extras.zip

  release:
    needs:
      - build
      - clone-and-prepare
    if: github.event.inputs.release_type != 'none'
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository ini
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          path: releases/
          pattern: NextUI-*
          merge-multiple: true

      - name: Create and Push Tag (opsional)
        if: github.event.inputs.release_type != 'none'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git tag "$GIT_NEXT_TAG"
          git push origin "$GIT_NEXT_TAG"
        env:
          GIT_NEXT_TAG: ${{ needs.clone-and-prepare.outputs.next-tag }}

      - name: Create GitHub Release
        if: github.event.inputs.release_type != 'none'
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          generate_release_notes: true
          append_body: true
          tag_name: ${{ needs.clone-and-prepare.outputs.next-tag }}
          make_latest: "true"
          body: |
            ## NextUI Build from External Repository
            
            **Build Information:**
            - Source Repository: ${{ github.event.inputs.source_repo }}
            - Source Branch: ${{ github.event.inputs.source_branch || 'main' }}
            - Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}
            - Build Date: $(date)
            
            **Generated Artifacts:**
            1. ${{ needs.clone-and-prepare.outputs.release-name }}-all.zip
            2. ${{ needs.clone-and-prepare.outputs.release-name }}-base.zip
            3. ${{ needs.clone-and-prepare.outputs.release-name }}-extras.zip
            
            ---
            
            For full features list and help on how to use NextUI:
            https://nextui.loveretro.games/docs/

            ## How to install/update
            For a fresh installation: https://nextui.loveretro.games/getting-started/installation/
            When updating from a previous release: https://nextui.loveretro.games/getting-started/updating/

      - name: Display Build Summary
        run: |
          echo ""
          echo "========================================"
          echo "âœ… BUILD COMPLETED SUCCESSFULLY"
          echo "========================================"
          echo "ðŸ“¦ Build Name: ${{ needs.clone-and-prepare.outputs.release-name }}"
          echo "ðŸ”— Source Repo: ${{ github.event.inputs.source_repo }}"
          echo "ðŸŒ¿ Source Branch: ${{ github.event.inputs.source_branch || 'main' }}"
          echo "ðŸ”– Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}"
          echo "ðŸ·ï¸  Next Tag: ${{ needs.clone-and-prepare.outputs.next-tag || 'No tag generated' }}"
          echo "ðŸ“ Build saved to: builds/${{ needs.clone-and-prepare.outputs.release-name }}/"
          echo ""
          echo "ðŸ“¦ Generated files:"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-all.zip"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-base.zip"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-extras.zip"
          echo ""
          echo "ðŸ’¾ Download from:"
          echo "  - GitHub Actions â†’ Artifacts â†’ ${{ needs.clone-and-prepare.outputs.release-name }}-build-output"
          if [ "${{ github.event.inputs.release_type }}" != "none" ]; then
            echo "  - GitHub Releases â†’ ${{ needs.clone-and-prepare.outputs.next-tag }}"
          fi
          echo "========================================"
