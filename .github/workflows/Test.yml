---
name: Clone and Build External Repo

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      source_repo:
        description: 'URL repository sumber yang akan di-clone dan build'
        required: true
        default: 'https://github.com/LoveRetro/NextUI.git'  # â­ INI DEFAULT VALUE
      source_branch:
        description: 'Branch yang akan di-clone'
        required: false
        default: 'main'
      make_targets:
        description: 'Target Makefile yang akan dijalankan (pisahkan dengan koma)'
        required: false
        default: 'setup tg5040 tg5050 special package'

jobs:
  clone-and-build:
    runs-on: ubuntu-24.04-arm
    env:
      SOURCE_REPO: ${{ github.event.inputs.source_repo }}
      SOURCE_BRANCH: ${{ github.event.inputs.source_branch || 'main' }}
      MAKE_TARGETS: ${{ github.event.inputs.make_targets }}
    
    steps:
      - name: Checkout repository tujuan
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 1

      - name: Clone repository sumber eksternal
        run: |
          echo "ğŸ” Cloning repository: $SOURCE_REPO"
          echo "ğŸŒ¿ Branch: $SOURCE_BRANCH"
          
          # Clone repository eksternal
          git clone --depth 1 --branch "$SOURCE_BRANCH" "$SOURCE_REPO" external-repo
          
          echo "âœ… Repository berhasil di-clone"
          
          # Simpan commit hash untuk tracking
          cd external-repo
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "ğŸ”– Commit Hash: $COMMIT_HASH"
          cd ..

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipmerge make git build-essential

      - name: Build dari repo eksternal
        run: |
          cd external-repo
          
          # Generate nama build otomatis
          REPO_NAME=$(basename -s .git "$SOURCE_REPO")
          BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_NAME="${REPO_NAME}-${BUILD_TIMESTAMP}-${COMMIT_HASH}"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV
          echo "ğŸ·ï¸ Release Name: $RELEASE_NAME"
          
          # Cek apakah Makefile ada
          if [ ! -f "Makefile" ]; then
            echo "âŒ ERROR: Makefile tidak ditemukan di repository sumber"
            exit 1
          fi
          
          echo "ğŸ“¦ Makefile ditemukan, memulai build..."
          echo "ğŸ¯ Targets: $MAKE_TARGETS"
          
          # Jalankan target Makefile
          for target in $(echo $MAKE_TARGETS | tr ',' ' '); do
            echo "ğŸ”¨ Running: make $target"
            make "$target" || {
              echo "âŒ make $target gagal"
              exit 1
            }
            echo "âœ… make $target berhasil"
          done
          
          # Cari dan copy file hasil build
          mkdir -p ../build-output
          
          # Cari file build di folder releases (jika ada)
          if [ -d "releases" ]; then
            echo "ğŸ“ Copy files from releases/"
            cp -r releases/* ../build-output/ 2>/dev/null || true
          fi
          
          # Juga cari file zip/bin di root
          find . -maxdepth 2 -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.bin" \) \
            -not -path "./.git/*" -exec cp {} ../build-output/ \; 2>/dev/null || true

      - name: Upload hasil build ke artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: build-${{ env.RELEASE_NAME }}
          path: build-output/
          retention-days: 30

      - name: Display build summary
        run: |
          echo "========================================"
          echo "âœ… BUILD SUMMARY"
          echo "========================================"
          echo "ğŸ“¦ Build Name: ${{ env.RELEASE_NAME }}"
          echo "ğŸ”— Source Repo: ${{ env.SOURCE_REPO }}"
          echo "ğŸŒ¿ Branch: ${{ env.SOURCE_BRANCH }}"
          echo "ğŸ”– Commit: ${{ env.COMMIT_HASH }}"
          echo "ğŸ¯ Make Targets: ${{ env.MAKE_TARGETS }}"
          echo "ğŸ“ Artifacts: build-${{ env.RELEASE_NAME }}"
          echo ""
          echo "ğŸ“‚ Generated files:"
          if [ -d "build-output" ] && [ "$(ls -A build-output)" ]; then
            ls -la build-output/
          else
            echo "  âš ï¸  No files generated (check if build produced output files)"
          fi
          echo "========================================"
