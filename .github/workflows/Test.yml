name: ðŸ—ï¸ Build MinUI - Multi Job

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Target device'
        required: true
        default: 'rg35xx'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      commit_hash: ${{ steps.clone.outputs.commit_hash }}
    
    steps:
    - name: Checkout builder
      uses: actions/checkout@v4
      
    - name: Clone MinUI
      id: clone
      run: |
        git clone --depth 1 https://github.com/shauninman/MinUI.git minui-build
        cd minui-build
        echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        
    - name: Apply patches
      run: |
        cd minui-build
        
        if [ -f "../patches/minui-ci.patch" ]; then
          patch -p1 -i "../patches/minui-ci.patch" || echo "Patch applied"
        fi
        
        if [ -f "../patches/apply-patch.sh" ]; then
          chmod +x "../patches/apply-patch.sh"
          "../patches/apply-patch.sh" || echo "Script done"
        fi
        
    - name: Upload patched source
      uses: actions/upload-artifact@v4
      with:
        name: minui-patched-source
        path: minui-build/
        retention-days: 1

  build:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: Download patched source
      uses: actions/download-artifact@v4
      with:
        name: minui-patched-source
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libsdl2-mixer-dev
        
    - name: Build
      run: |
        cd minui-build
        make TARGET=${{ github.event.inputs.target_device }} || make
        
        echo "Build outputs:"
        find . -name "*.zip" -o -name "*.elf" -o -name "*.img" || echo "No outputs"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: minui-build-output
        path: minui-build/*.zip
