---
name: Clone and Build MinUI

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "URL repository MinUI yang akan di-clone"
        default: "https://github.com/shauninman/MinUI.git"
        required: true
      source_branch:
        description: "Branch yang akan di-clone"
        default: "main"
        required: false
      release_type:
        description: "Release type untuk tag"
        default: "none"
        required: true
        type: choice
        options:
          - none
          - patch
          - minor
          - major
          - date  # Menambahkan opsi date-based versioning

permissions:
  attestations: write
  contents: write
  id-token: write

jobs:
  clone-and-prepare:
    runs-on: ubuntu-24.04
    outputs:
      next-tag: ${{ steps.next-tag.outputs.version }}
      release-name: ${{ steps.release-name.outputs.RELEASE_NAME }}
      commit-hash: ${{ steps.get-commit.outputs.commit-hash }}
    steps:
      - name: Checkout repository tujuan (untuk menyimpan hasil)
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Clone repository MinUI
        id: clone-repo
        run: |
          echo "ðŸ” Cloning repository: ${{ github.event.inputs.source_repo }}"
          echo "ðŸŒ¿ Branch: ${{ github.event.inputs.source_branch || 'main' }}"
          
          # Clone repository MinUI
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" MinUI-source
          
          echo "âœ… Repository berhasil di-clone"
          cd MinUI-source
          
          # Simpan informasi commit
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_OUTPUT
          
          # Generate release name
          if [ -f "makefile" ] && make -n name 2>/dev/null; then
            RELEASE_NAME=$(make name)
          else
            RELEASE_NAME="MinUI-build-$(date +%Y%m%d-%H%M%S)-$COMMIT_HASH"
          fi
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          # Get latest tag dari repo sumber
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          echo "ðŸ”– Latest Tag: $LATEST_TAG"
          echo "ðŸ·ï¸ Release Name: $RELEASE_NAME"
          echo "ðŸ”— Commit: $COMMIT_HASH"

      - name: Generate Release Name
        id: release-name
        run: |
          echo "RELEASE_NAME=${{ steps.clone-repo.outputs.RELEASE_NAME }}" >> "$GITHUB_OUTPUT"

      - name: Get Commit Hash
        id: get-commit
        run: |
          echo "commit-hash=${{ steps.clone-repo.outputs.COMMIT_HASH }}" >> "$GITHUB_OUTPUT"

      - name: Generate Next Tag (Date-based or SemVer)
        id: generate-tag
        if: github.event.inputs.release_type != 'none'
        run: |
          LATEST_TAG="${{ steps.clone-repo.outputs.LATEST_TAG }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          TODAY=$(date +%Y%m%d)
          
          echo "Latest tag: $LATEST_TAG"
          echo "Release type: $RELEASE_TYPE"
          
          # Jika release_type adalah 'date' atau tag terakhir format tanggal
          if [[ "$RELEASE_TYPE" == "date" ]] || [[ "$LATEST_TAG" =~ ^v[0-9]{8}-[0-9]+$ ]]; then
            echo "Using date-based versioning..."
            
            if [[ -z "$LATEST_TAG" ]] || [[ "$LATEST_TAG" == "v0.0.0" ]]; then
              # Tidak ada tag sebelumnya, mulai dari 1
              NEW_TAG="v${TODAY}-1"
              echo "No previous tag, starting with: $NEW_TAG"
            elif [[ "$LATEST_TAG" =~ ^v([0-9]{8})-([0-9]+)$ ]]; then
              LAST_DATE=${BASH_REMATCH[1]}
              LAST_NUMBER=${BASH_REMATCH[2]}
              
              echo "Last build date: $LAST_DATE, build number: $LAST_NUMBER"
              
              if [[ "$LAST_DATE" == "$TODAY" ]]; then
                # Hari yang sama, increment nomor
                NEW_NUMBER=$((LAST_NUMBER + 1))
                NEW_TAG="v${TODAY}-${NEW_NUMBER}"
                echo "Same day, incrementing to: $NEW_TAG"
              else
                # Hari baru, mulai dari 1
                NEW_TAG="v${TODAY}-1"
                echo "New day, starting with: $NEW_TAG"
              fi
            else
              # Format tidak sesuai, mulai dari 1 hari ini
              NEW_TAG="v${TODAY}-1"
              echo "Invalid format, starting with: $NEW_TAG"
            fi
            
          else
            # Gunakan SemVer dengan semver-generator untuk patch/minor/major
            echo "Using Semantic Versioning..."
            
            # Default tag jika tidak ada
            if [[ -z "$LATEST_TAG" ]]; then
              LATEST_TAG="v0.0.0"
            fi
            
            # Pastikan tag dimulai dengan 'v'
            if [[ ! "$LATEST_TAG" =~ ^v ]]; then
              LATEST_TAG="v$LATEST_TAG"
            fi
            
            echo "Using semver-generator with input: $LATEST_TAG"
            
            # Simpan input ke file untuk docker
            echo "$LATEST_TAG" > /tmp/input_version.txt
            
            # Run semver-generator via docker
            NEW_TAG=$(docker run --rm \
              -e "INPUT_BUMP=$RELEASE_TYPE" \
              -v /tmp/input_version.txt:/tmp/input.txt \
              ghcr.io/dokku/semver-generator:latest \
              sh -c 'cat /tmp/input.txt | xargs -I {} echo -n {}' 2>/dev/null || echo "")
            
            # Fallback jika semver-generator gagal
            if [[ -z "$NEW_TAG" ]]; then
              echo "semver-generator failed, using manual increment..."
              if [[ "$LATEST_TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                MAJOR=${BASH_REMATCH[1]}
                MINOR=${BASH_REMATCH[2]}
                PATCH=${BASH_REMATCH[3]}
                
                case "$RELEASE_TYPE" in
                  "major") NEW_TAG="v$((MAJOR + 1)).0.0" ;;
                  "minor") NEW_TAG="v$MAJOR.$((MINOR + 1)).0" ;;
                  "patch") NEW_TAG="v$MAJOR.$MINOR.$((PATCH + 1))" ;;
                  *) NEW_TAG="v$MAJOR.$MINOR.$PATCH" ;;
                esac
              else
                NEW_TAG="v1.0.0"
              fi
            fi
            
            echo "Generated SemVer tag: $NEW_TAG"
          fi
          
          echo "next-tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "âœ… Generated tag: $NEW_TAG"

  core-matrix:
    needs: clone-and-prepare
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    outputs:
      cores: ${{ steps.cores.outputs.cores }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040
          - tg5050

    steps:
      - name: Clone repository MinUI (untuk build)
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" MinUI-source
          cd MinUI-source

      - name: Generate cores matrix
        id: cores
        run: |
          cd nextui-source
          # Cek apakah ini MinUI repository
          if [[ "${{ github.event.inputs.source_repo }}" == *"MinUI"* ]] || [ ! -f "makefile" ]; then
            echo "âš ï¸ MinUI detected or no Makefile, using default cores"
            # Default cores untuk platform umum
            CORES='["gba", "nes", "snes", "gb", "gbc", "md", "psx"]'
          else
            # Coba gunakan cores-json jika ada
            if make -n cores-json 2>/dev/null; then
              CORES="$(make cores-json)"
            else
              echo "âš ï¸ cores-json target not found, using default"
              CORES='["core1", "core2", "core3"]'
            fi
          fi
          echo "cores=$CORES" >> $GITHUB_OUTPUT
          echo "Generated cores: $CORES"

  build-core:
    needs: core-matrix
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040
          - tg5050
        core: ${{ fromJson(needs.core-matrix.outputs.cores) }}
    steps:
      - name: Clone repository MinUI
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" MinUI-source
          cd MinUI-source

      - name: Setup
        run: |
          cd MinUI-source
          make setup

      - name: Build ${{ matrix.core }} core
        run: |
          cd MinUI-source
          make build-core CORE=${{ matrix.core }}

      - name: Upload core artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: core-${{ matrix.toolchain }}-${{ matrix.core }}.zip
          path: MinUI-source/workspace/${{ env.PLATFORM }}/cores/output/

  build:
    needs:
      - clone-and-prepare
      - build-core
    runs-on: ubuntu-24.04-arm
    env:
      RELEASE_NAME: ${{ needs.clone-and-prepare.outputs.release-name }}
    steps:
      - name: Clone repository MinUI untuk final build
        run: |
          git clone --depth 1 --branch "${{ github.event.inputs.source_branch || 'main' }}" \
            "${{ github.event.inputs.source_repo }}" MinUI-source
          cd MinUI-source

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipmerge

      - name: Setup build environment
        run: |
          cd MinUI-source
          make setup

      - name: Download Cores (tg5040)
        uses: actions/download-artifact@v4.3.0
        with:
          path: MinUI-source/workspace/tg5040/cores/output/
          pattern: core-tg5040-*
          merge-multiple: true

      - name: Build untuk tg5040 platform
        run: |
          cd MinUI-source
          make tg5040
        env:
          PLATFORM: tg5040

      - name: Download Cores (tg5050)
        uses: actions/download-artifact@v4.3.0
        with:
          path: MinUI-source/workspace/tg5050/cores/output/
          pattern: core-tg5050-*
          merge-multiple: true

      - name: Build untuk tg5050 platform
        run: |
          cd MinUI-source
          make tg5050
        env:
          PLATFORM: tg5050

      - name: Build komponen special
        run: |
          cd MinUI-source
          make special

      - name: Package semua build
        run: |
          cd MinUI-source
          make package

      - name: Upload hasil build ke artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ env.RELEASE_NAME }}-build-output
          path: |
            MinUI-source/releases/${{ env.RELEASE_NAME }}-all.zip
            MinUI-source/releases/${{ env.RELEASE_NAME }}-base.zip
            MinUI-source/releases/${{ env.RELEASE_NAME }}-extras.zip
          retention-days: 30

      - name: Copy hasil build ke repository ini
        run: |
          # Buat folder untuk menyimpan build di repo ini
          mkdir -p builds/${{ env.RELEASE_NAME }}
          
          # Copy file hasil build
          if [ -f "MinUI-source/releases/${{ env.RELEASE_NAME }}-all.zip" ]; then
            cp MinUI-source/releases/${{ env.RELEASE_NAME }}-all.zip builds/${{ env.RELEASE_NAME }}/
          fi
          if [ -f "MinUI-source/releases/${{ env.RELEASE_NAME }}-base.zip" ]; then
            cp MinUI-source/releases/${{ env.RELEASE_NAME }}-base.zip builds/${{ env.RELEASE_NAME }}/
          fi
          if [ -f "MinUI-source/releases/${{ env.RELEASE_NAME }}-extras.zip" ]; then
            cp MinUI-source/releases/${{ env.RELEASE_NAME }}-extras.zip builds/${{ env.RELEASE_NAME }}/
          fi
          
          # Buat file info build
          cat > builds/${{ env.RELEASE_NAME }}/build-info.txt << EOF
          Build Information
          =================
          Build Name: ${{ env.RELEASE_NAME }}
          Source Repo: ${{ github.event.inputs.source_repo }}
          Source Branch: ${{ github.event.inputs.source_branch || 'main' }}
          Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}
          Build Date: $(date)
          Release Type: ${{ github.event.inputs.release_type }}
          =================
          EOF
          
          # Tampilkan struktur file
          echo "ðŸ“ Build files saved to builds/${{ env.RELEASE_NAME }}/:"
          ls -la builds/${{ env.RELEASE_NAME }}/

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2.3.0
        with:
          subject-path: |
            MinUI-source/releases/${{ env.RELEASE_NAME }}-all.zip
            MinUI-source/releases/${{ env.RELEASE_NAME }}-base.zip
            MinUI-source/releases/${{ env.RELEASE_NAME }}-extras.zip

  release:
    needs:
      - build
      - clone-and-prepare
    if: github.event.inputs.release_type != 'none'
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository ini
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          path: releases/
          pattern: MinUI-*
          merge-multiple: true

      - name: Create and Push Tag (opsional)
        if: github.event.inputs.release_type != 'none'
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git tag "$GIT_NEXT_TAG"
          git push origin "$GIT_NEXT_TAG"
        env:
          GIT_NEXT_TAG: ${{ needs.clone-and-prepare.outputs.next-tag }}

      - name: Create GitHub Release
        if: github.event.inputs.release_type != 'none'
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          generate_release_notes: true
          append_body: true
          tag_name: ${{ needs.clone-and-prepare.outputs.next-tag }}
          make_latest: "true"
          body: |
            ## MinUI Build from External Repository
            
            **Build Information:**
            - Source Repository: ${{ github.event.inputs.source_repo }}
            - Source Branch: ${{ github.event.inputs.source_branch || 'main' }}
            - Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}
            - Build Date: $(date)
            
            **Generated Artifacts:**
            1. ${{ needs.clone-and-prepare.outputs.release-name }}-all.zip
            2. ${{ needs.clone-and-prepare.outputs.release-name }}-base.zip
            3. ${{ needs.clone-and-prepare.outputs.release-name }}-extras.zip
            
            ---
            
            For full features list and help on how to use MinUI:
            https://nextui.loveretro.games/docs/

            ## How to install/update
            For a fresh installation: https://nextui.loveretro.games/getting-started/installation/
            When updating from a previous release: https://nextui.loveretro.games/getting-started/updating/

      - name: Display Build Summary
        run: |
          echo ""
          echo "========================================"
          echo "âœ… BUILD COMPLETED SUCCESSFULLY"
          echo "========================================"
          echo "ðŸ“¦ Build Name: ${{ needs.clone-and-prepare.outputs.release-name }}"
          echo "ðŸ”— Source Repo: ${{ github.event.inputs.source_repo }}"
          echo "ðŸŒ¿ Source Branch: ${{ github.event.inputs.source_branch || 'main' }}"
          echo "ðŸ”– Commit Hash: ${{ needs.clone-and-prepare.outputs.commit-hash }}"
          echo "ðŸ·ï¸  Next Tag: ${{ needs.clone-and-prepare.outputs.next-tag || 'No tag generated' }}"
          echo "ðŸ“ Build saved to: builds/${{ needs.clone-and-prepare.outputs.release-name }}/"
          echo ""
          echo "ðŸ“¦ Generated files:"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-all.zip"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-base.zip"
          echo "  - ${{ needs.clone-and-prepare.outputs.release-name }}-extras.zip"
          echo ""
          echo "ðŸ’¾ Download from:"
          echo "  - GitHub Actions â†’ Artifacts â†’ ${{ needs.clone-and-prepare.outputs.release-name }}-build-output"
          if [ "${{ github.event.inputs.release_type }}" != "none" ]; then
            echo "  - GitHub Releases â†’ ${{ needs.clone-and-prepare.outputs.next-tag }}"
          fi
          echo "========================================"
