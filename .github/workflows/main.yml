name: ğŸ—ï¸ Build MinUI with CI Patches

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Target device/platform'
        required: true
        default: 'rg35xx'
        type: choice
        options:
        - rg35xx
        - rgb30
        - miyoomini
        - default
      clean_build:
        description: 'Clean build directory'
        required: true
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: false
        type: boolean
      release_tag:
        description: 'Release tag name'
        required: false
        default: ''

  # Auto build on push to main
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/**'
      - 'scripts/**'
      - '.github/patches/**'

  # Schedule daily build
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily

env:
  MINUI_REPO: "https://github.com/shauninman/MinUI.git"
  BUILD_DIR: "minui-build"
  OUTPUT_DIR: "artifacts"

jobs:
  setup-and-patch:
    name: "âš™ï¸ Setup & Patch"
    runs-on: ubuntu-latest
    outputs:
      build_version: ${{ steps.version.outputs.version }}
      commit_hash: ${{ steps.clone.outputs.commit_hash }}
    
    steps:
    - name: "ğŸ“¦ Checkout builder repository"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "ğŸ”„ Clone MinUI repository"
      id: clone
      run: |
        echo "Cloning MinUI from $MINUI_REPO"
        rm -rf $BUILD_DIR
        git clone --depth 1 $MINUI_REPO $BUILD_DIR
        
        # Get commit hash
        cd $BUILD_DIR
        COMMIT_HASH=$(git rev-parse --short HEAD)
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ MinUI commit: $COMMIT_HASH"
        
    - name: "ğŸ”§ Apply CI patches"
      run: |
        echo "Applying patches to MinUI Makefile..."
        cd $BUILD_DIR
        
        # Apply patch file if exists
        if [ -f "../patches/minui-ci.patch" ]; then
          echo "ğŸ“‹ Applying patch file..."
          patch -p1 -i "../patches/minui-ci.patch" || echo "âš ï¸ Patch may have been already applied"
        fi
        
        # Run patch script
        chmod +x "../patches/apply-patch.sh"
        "../patches/apply-patch.sh" || echo "â„¹ï¸ Patch script completed"
        
        # Verify patches
        echo "âœ… Patch verification:"
        grep -n "tty\|CI\|find" makefile | head -10
        
    - name: "ğŸ“ Generate build version"
      id: version
      run: |
        cd $BUILD_DIR
        DATE=$(date +%Y%m%d)
        COMMIT_SHORT=$(git rev-parse --short HEAD)
        VERSION="MinUI-$DATE-$COMMIT_SHORT"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Build version: $VERSION"

  build:
    name: "ğŸ”¨ Build MinUI"
    runs-on: ubuntu-latest
    needs: setup-and-patch
    strategy:
      matrix:
        python_version: ['3.9']
    
    steps:
    - name: "ğŸ“¦ Checkout builder"
      uses: actions/checkout@v4
      
    - name: "ğŸ“‚ Load patched source"
      uses: actions/cache@v3
      with:
        path: ${{ env.BUILD_DIR }}
        key: ${{ runner.os }}-minui-${{ needs.setup-and-patch.outputs.commit_hash }}-patched
        
    - name: "ğŸ“¥ Install dependencies"
      run: |
        chmod +x ./scripts/install-deps.sh
        ./scripts/install-deps.sh
        
    - name: "ğŸ Setup Python"
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python_version }}
        
    - name: "ğŸ—ï¸ Build MinUI"
      env:
        TARGET: ${{ github.event.inputs.target_device }}
        CLEAN_BUILD: ${{ github.event.inputs.clean_build }}
        BUILD_VERSION: ${{ needs.setup-and-patch.outputs.build_version }}
      run: |
        chmod +x ./scripts/build.sh
        ./scripts/build.sh
        
        # Create artifacts directory
        mkdir -p $OUTPUT_DIR
        cp $BUILD_DIR/*.zip $BUILD_DIR/*.elf $BUILD_DIR/*.img $OUTPUT_DIR/ 2>/dev/null || true
        
        echo "ğŸ“ Build outputs:"
        ls -la $OUTPUT_DIR/ || echo "No output files found"
        
    - name: "ğŸ“¦ Package artifacts"
      run: |
        chmod +x ./scripts/package-release.sh
        ./scripts/package-release.sh "${{ needs.setup-and-patch.outputs.build_version }}"
        
    - name: "ğŸ’¾ Upload build artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: minui-build-${{ github.run_number }}
        path: |
          ${{ env.OUTPUT_DIR }}/*
          build.log
        retention-days: 30

  release:
    name: "ğŸš€ Create Release"
    needs: build
    if: github.event.inputs.create_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: "ğŸ“¥ Download artifacts"
      uses: actions/download-artifact@v4
      with:
        name: minui-build-${{ github.run_number }}
        path: release-assets
        
    - name: "ğŸ·ï¸ Create GitHub Release"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.release_tag || format('build-{0}', github.run_number) }}
        name: "MinUI Build #${{ github.run_number }}"
        body: |
          ## MinUI CI Build
          
          **Build Information:**
          - Version: ${{ needs.setup-and-patch.outputs.build_version }}
          - Commit: ${{ needs.setup-and-patch.outputs.commit_hash }}
          - Target: ${{ github.event.inputs.target_device }}
          - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          **Artifacts:**
          - MinUI firmware image
          - Build logs
          
          ---
          
          *Automatically built by GitHub Actions*
          
        draft: false
        prerelease: false
        files: |
          release-assets/*
        generate_release_notes: true
